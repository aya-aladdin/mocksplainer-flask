{% extends 'base.html' %}

{% block title %}Chatbot Tutor{% endblock %}

{% block content %}
    <div class="card">
        <div class="pad">
            <h1 class="section-title">Chatbot Tutor</h1>
            <div id="chat-container">
                <div id="chat-messages"></div>
                <form id="chat-form">
                    <input type="text" id="chat-input" placeholder="Ask a question...">
                    <button type="submit">Send</button>
                </form>
                <button id="generate-flashcards">Generate Flashcards</button>
            </div>
        </div>
    </div>

    <script>
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const message = chatInput.value;
            if (!message) return;

            appendMessage('user', message);
            chatInput.value = '';

            try {
                const response = await fetch('/api/chatbot', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                });

                if (!response.ok) {
                    throw new Error('Failed to get response from chatbot');
                }

                const data = await response.json();
                const botMessage = data.choices[0].message.content;
                appendMessage('bot', botMessage);

            } catch (error) {
                console.error('Error:', error);
                appendMessage('bot', 'Sorry, something went wrong. Please try again.');
            }
        });

        const generateFlashcardsBtn = document.getElementById('generate-flashcards');

        generateFlashcardsBtn.addEventListener('click', async () => {
            const messages = Array.from(chatMessages.children).map(messageElement => {
                return {
                    sender: messageElement.classList.contains('user-message') ? 'user' : 'bot',
                    message: messageElement.innerText
                };
            });

            try {
                const response = await fetch('/generate_flashcards', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ messages })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate flashcards');
                }

                const data = await response.json();
                alert(data.message);
                window.location.href = '{{ url_for("flashcards") }}';

            } catch (error) {
                console.error('Error:', error);
                alert('Sorry, something went wrong. Please try again.');
            }
        });
    </script>
{% endblock %}