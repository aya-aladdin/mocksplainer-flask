{% extends 'base.html' %}

{% block title %}Chatbot Tutor{% endblock %}

{% block content %}
    <div class="card">
        <div class="pad">
            <h1 class="section-title">Chatbot Tutor</h1>
            <div id="chat-container">
                <div id="chat-messages"></div>
                <form id="chat-form">
                    <input type="text" id="chat-input" placeholder="Ask a question...">
                    <button type="submit">Send</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');

        function appendMessage(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            // A simple markdown-to-html for links
            text = text.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>');
            messageElement.innerHTML = sender === 'user' ? text : text; // Can use a library like 'marked' for full markdown
            messageElement.classList.add(sender === 'user' ? 'user-message' : 'bot-message');
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const message = chatInput.value;
            if (!message) return;

            appendMessage('user', message);
            chatInput.value = '';

            try {
                const response = await fetch("{{ url_for('chat') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                });

                if (!response.ok) {
                    throw new Error('Failed to get response from chatbot');
                }

                const data = await response.json();
                appendMessage('bot', data.reply);

            } catch (error) {
                console.error('Error:', error);
                appendMessage('bot', 'Sorry, something went wrong. Please try again.');
            }
        });
    </script>
{% endblock %}